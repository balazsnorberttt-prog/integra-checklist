<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INTEGRA CHECKLIST V12 - STYLE PRESERVER</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- ST√çLUSOK (Ugyanaz, mint eddig) --- */
        :root {
            --bg: #121212; --card: #1e1e1e; --primary: #00bcd4;
            --success: #00e676; --danger: #ff5252; --excel: #21a366; --text: #ffffff;
        }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; padding-bottom: 140px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        .input-group label { color: var(--primary); font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 5px; }
        .input-group input { background: #2c2c2c; border: 1px solid #444; color: #fff; width: 100%; padding: 12px; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        .section-header { background: #252525; color: var(--primary); padding: 15px; font-weight: bold; margin-top: 30px; border-left: 4px solid var(--primary); border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; }
        .section-content { display: none; margin-top: 10px; }
        .section-content.active { display: block; }
        .item-box { background: var(--card); padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #333; position: relative; }
        .item-box[data-status="OK"] { border-left: 6px solid var(--success); }
        .item-box[data-status="NOK"] { border-left: 6px solid var(--danger); }
        .id-tag { background: #333; color: var(--primary); padding: 3px 6px; font-size: 0.75rem; border-radius: 4px; font-weight: bold; }
        .q-text { font-size: 1.05rem; margin: 12px 0; line-height: 1.4; font-weight: 500; }
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: #fff; }
        .btn-guide { flex: 0 0 50px; background: #333; color: var(--primary); }
        .btn-ok { background: #1b5e20; opacity: 0.6; }
        .btn-nok { background: #b71c1c; opacity: 0.6; }
        .btn-ok.active { background: var(--success); color: #000; opacity: 1; }
        .btn-nok.active { background: var(--danger); color: #fff; opacity: 1; }
        .details { display: none; margin-top: 15px; border-top: 1px dashed #444; padding-top: 15px; }
        .guide-box { background: rgba(0,188,212,0.1); color: #ddd; padding: 12px; border-radius: 6px; margin-bottom: 15px; white-space: pre-line; border-left: 2px solid var(--primary); }
        textarea { width: 100%; background: #111; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 6px; min-height: 60px; }
        .floating-footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(30,30,30,0.95); border-top: 2px solid var(--primary); padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 999; }
        .footer-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .score { font-size: 1.5rem; color: var(--primary); font-weight: bold; }
        .btn-action { padding: 10px 20px; border-radius: 30px; font-weight: bold; border: none; font-size: 0.9rem; text-transform: uppercase; }
        .btn-pdf { background: var(--primary); color: #000; }
        .btn-excel { background: var(--excel); color: #fff; position: relative; overflow: hidden; }
        #excelInput { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        /* Print st√≠lusok */
        #print-header { display: none; }
        @media print {
            .floating-footer, .btn-guide, .btn-row button, .input-group, .subtitle { display: none !important; }
            .card { border: none; padding: 0; }
            #print-header { display: block; border-bottom: 2px solid #000; margin-bottom: 20px; }
            .section-header { background: #eee !important; color: #000 !important; border: none !important; border-bottom: 1px solid #000 !important; }
            .section-content { display: block !important; }
            .item-box { border: none; border-bottom: 1px dotted #ccc; page-break-inside: avoid; color: #000; }
            .item-box[data-status="OK"]::after { content: "‚úî MEGFELEL≈ê"; color: green; float: right; margin-top: -30px; font-weight: bold;}
            .item-box[data-status="NOK"]::after { content: "‚úñ HIB√ÅS"; color: red; float: right; margin-top: -30px; font-weight: bold;}
        }
    </style>
</head>
<body>

<div id="print-header">
    <h1>INTEGRA ELLEN≈êRZ√âSI JEGYZ≈êK√ñNYV</h1>
    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
        <span><strong>Berendez√©s:</strong> <span id="p-dev">-</span></span>
        <span><strong>D√°tum:</strong> <span id="p-date">-</span></span>
    </div>
    <div style="display:flex; justify-content:space-between;">
        <span><strong>Ellen≈ër:</strong> <span id="p-op">-</span></span>
        <span><strong>Eredm√©ny:</strong> <span id="p-score">0%</span></span>
    </div>
</div>

<div class="card">
    <h1 style="color:var(--primary); margin:0;">INTEGRA CHECKLIST v12</h1>
    <span class="subtitle" style="color:#888; display:block; margin-bottom:20px;">Excel Style-Preserver Edition</span>
    
    <div class="input-group">
        <label>BERENDEZ√âS NEVE</label>
        <input type="text" id="devName" placeholder="pl. OP10" oninput="syncData()">
    </div>
    <div class="input-group">
        <label>ELLEN≈êR NEVE</label>
        <input type="text" id="opName" placeholder="N√©v..." oninput="syncData()">
    </div>
</div>

<div id="root"></div>

<div class="floating-footer">
    <div class="footer-row">
        <span style="color:#aaa;">Eredm√©ny:</span>
        <div class="score" id="scoreDisplay">0%</div>
    </div>
    <div class="footer-row">
        <button class="btn-action btn-pdf" onclick="savePDF()">üìÑ PDF</button>
        <button class="btn-action btn-excel">
            üìó EXCEL FELT√ñLT√âS & MENT√âS
            <input type="file" id="excelInput" accept=".xlsx" onchange="handleExcel(this)">
        </button>
    </div>
</div>

<script>
    // --- ADATB√ÅZIS ---
    const data = [
        { cat: "1.1.0 H√ÅL√ìZAT", items: [
            { id: "1.1.1", t: "H√°l√≥zati telep√≠t√©s el≈ë√≠r√°s szerinti?", g: "Online topol√≥gi√°t megnyitni √©s ellen≈ërizni..." },
            { id: "1.1.2", t: "G√©pn√©v egyedi √©s egyeztetve?", g: "G√©pn√©v egyeztetve √©s egy√©rtelm≈±" },
            { id: "1.1.3", t: "Ondeso tool futott?", g: "Ondeso tool rendben fut rajta..." }
        ]},
        { cat: "1.2.0 SZOFTVER", items: [
            { id: "1.2.1", t: "Image Verzi√≥ aktu√°lis?", g: "OS-Info-t elind√≠tani..." },
            { id: "1.2.2", t: "TIA Portal verzi√≥ megfelel≈ë?", g: "TIA verzi√≥ ellen≈ërz√©s V16 UB" },
            { id: "1.2.3", t: "Safety verzi√≥ megfelel≈ë?", g: "TIA verzi√≥ ellen≈ërz√©s" },
            { id: "1.2.4", t: "Integra Designer verzi√≥?", g: "6.9.7.0 vagy ellen≈ërizni a g√©peket..." }
        ]},
        { cat: "1.3.0 HARDWARE", items: [
             { id: "1.3.1", t: "PC feliratozva?", g: "Pult jel√∂l√©s (Nyomtatva vagy grav√≠rozva)" }
        ]},
        { cat: "1.4.0 RENDSZER", items: [
            { id: "1.4.1", t: "Rendszerdiagnosztika hiba n√©lk√ºl?", g: "Integra System Manager..." },
            { id: "1.4.2", t: "IntegraCheck OK?", g: "VMC, Vizualiz√°ci√≥: Men√º/IntegraCheck" },
            { id: "1.4.3", t: "Mozg√°sk√©pek rendben?", g: "Minden Visu-ban ellen≈ërizni..." },
            { id: "1.4.4", t: "Interf√©sz k√©pek rendben?", g: "Mozg√°s k√©perny≈ë ikonja mellett..." },
            { id: "1.4.5", t: "Designer Templates OK?", g: "Ha a System z√∂ld, akkor j√≥..." },
            { id: "1.4.6", t: "Scriptek dokument√°lva?", g: "idPro projektet let√∂lteni..." },
            { id: "1.4.7", t: "Nyelv be√°ll√≠tva?", g: "Ellen≈ërizni a nyelvv√°lt√°st" }
        ]},
        { cat: "1.6.0 KIEG√âSZ√çT√âSEK", items: [
            { id: "1.6.1", t: "Mintaprojektek betartva?", g: "RB, MO, FT el≈ë√≠r√°sok" },
            { id: "1.6.2", t: "Tech param√©terek j√≥ helyen?", g: "D:\\CMWProjekt mappa" },
            { id: "1.6.3", t: "IntegraShell konfigur√°ci√≥?", g: "Tiltja a programok futtat√°s√°t..." },
            { id: "1.6.4", t: "EKM kapcsolat?", g: "Szerverr≈ël kapja..." },
            { id: "1.6.5", t: "isiSave be√°ll√≠tva?", g: "isiSave program ellen≈ërz√©s" },
            { id: "1.6.6", t: "Index-Szerver OK?", g: "Systemmanager online..." },
            { id: "1.6.8", t: "SIS Log tiszta?", g: "D:\\integra\\System\\Logs\\SisServer.csv" },
            { id: "1.6.9", t: "Mappastrukt√∫ra OK?", g: "CMWProjekt mappa fel√©p√≠t√©se" },
            { id: "1.6.10", t: "Szem√©t t√∂r√∂lve?", g: "Nincs m√°s TIA projekt" },
            { id: "1.6.11", t: "V√≠rusirt√≥ friss√ºl?", g: "Antiv√≠rus szoftver telep√≠tve" }
        ]},
        { cat: "2.1.0 PLC (SPS)", items: [
            { id: "2.1.1", t: "Minden PLC ter√ºlet l√°tszik?", g: "Ter√ºlet v√°laszt√≥ k√©perny≈ë" },
            { id: "2.1.2", t: "Minden ter√ºletnek van vizuja?", g: "SPS ter√ºlet vizualiz√°ci√≥" },
            { id: "2.1.3", t: "Full HD felbont√°s?", g: "Projekttervez≈ëben Full HD" },
            { id: "2.1.4", t: "Calibri 10 Bold?", g: "Bet≈±t√≠pus ellen≈ërz√©s" },
            { id: "2.1.5", t: "Pult 99 (Nyers) ablak?", g: "Helyettes√≠t≈ë ablak funkci√≥" },
            { id: "2.1.6", t: "PNG √°tl√°tsz√≥ k√©pek?", g: "Kb. 100 KB f√°jlm√©ret" }
        ]},
        { cat: "2.2.0 K√âPERNY≈êK", items: [
            { id: "2.2.1", t: "√Åttekint≈ë k√©pek OK?", g: "Szab√°lyzat szerint" },
            { id: "2.3.1", t: "Pult k√©pek OK?", g: "Szab√°lyzat szerint" },
            { id: "2.4.1", t: "√Ållom√°s k√©pek OK?", g: "Szab√°lyzat szerint" },
            { id: "2.5.1", t: "Speci√°lis funkci√≥k OK?", g: "Szab√°lyzat szerint" },
            { id: "2.5.3", t: "Betriebsfunktionen OK?", g: "Szab√°lyzat szerint" },
            { id: "2.5.4", t: "Robot √°ttekint≈ëk OK?", g: "Szab√°lyzat szerint" },
            { id: "2.6.0", t: "R√©szletk√©pek (Zusatz)", g: "Szab√°lyzat szerint" },
            { id: "2.6.1", t: "Nincs Station/Pult elem?", g: "Nincsenek magasabb szint≈± elemek" },
            { id: "2.6.2", t: "V√©szle√°ll√≠t√≥ (SonderBit)?", g: "DYN_GEN_SonderBit_Endlage_Absolut" },
            { id: "2.6.3", t: "R√©szletk√©pek OK?", g: "St√°ci√≥ r√©szletes k√©perny≈ë" }
        ]}
    ];

    const root = document.getElementById('root');

    function render() {
        data.forEach((sect, idx) => {
            const h = document.createElement('div');
            h.className = 'section-header';
            h.innerHTML = `<span>${sect.cat}</span> <span>‚ñº</span>`;
            h.onclick = () => document.getElementById(`sec-${idx}`).classList.toggle('active');
            
            const c = document.createElement('div');
            c.className = 'section-content';
            c.id = `sec-${idx}`;
            if(idx === 0) c.classList.add('active'); 

            sect.items.forEach(item => {
                const uid = item.id.replace(/\./g, '_');
                c.innerHTML += `
                    <div class="item-box" id="box-${uid}" data-id="${item.id}">
                        <span class="id-tag">${item.id}</span>
                        <div class="q-text">${item.t}</div>
                        <div class="btn-row">
                            <button class="btn-guide" onclick="toggleDetails('${uid}')">?</button>
                            <button class="btn-ok" onclick="setStatus('${uid}', 'OK')">OK</button>
                            <button class="btn-nok" onclick="setStatus('${uid}', 'NOK')">NOK</button>
                        </div>
                        <div class="details" id="det-${uid}">
                            <div class="guide-box">${item.g}</div>
                            <textarea placeholder="Megjegyz√©s √≠r√°sa..." id="com-${uid}"></textarea>
                        </div>
                    </div>
                `;
            });
            root.appendChild(h);
            root.appendChild(c);
        });
        document.getElementById('p-date').innerText = new Date().toLocaleString();
    }

    function toggleDetails(uid) {
        const el = document.getElementById(`det-${uid}`);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function setStatus(uid, s) {
        const box = document.getElementById(`box-${uid}`);
        const btns = box.querySelectorAll('.btn-row button');
        btns[1].classList.remove('active');
        btns[2].classList.remove('active');
        box.setAttribute('data-status', s);

        if(s === 'OK') { btns[1].classList.add('active'); } 
        else { btns[2].classList.add('active'); document.getElementById(`det-${uid}`).style.display = 'block'; }
        calc();
    }

    function calc() {
        const all = document.querySelectorAll('.item-box').length;
        const ok = document.querySelectorAll('.item-box[data-status="OK"]').length;
        const pct = Math.round((ok/all)*100);
        document.getElementById('scoreDisplay').innerText = pct + "%";
        document.getElementById('p-score').innerText = pct + "%";
    }

    function syncData() {
        document.getElementById('p-dev').innerText = document.getElementById('devName').value;
        document.getElementById('p-op').innerText = document.getElementById('opName').value;
    }

    function savePDF() {
        const name = document.getElementById('devName').value || "Checklist";
        document.title = name + "_Jegyzokonyv";
        syncData();
        document.querySelectorAll('.section-content').forEach(el => el.classList.add('active'));
        window.print();
    }

    // --- PROFESSZION√ÅLIS EXCEL KEZEL√âS (EXCELJS) ---
    async function handleExcel(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const devName = document.getElementById('devName').value || "Gep";

        const workbook = new ExcelJS.Workbook();
        const reader = new FileReader();

        reader.onload = async function(e) {
            const buffer = e.target.result;
            
            try {
                // Bet√∂ltj√ºk a megl√©v≈ë f√°jlt szerkezettel egy√ºtt
                await workbook.xlsx.load(buffer);
                
                // V√©gigmegy√ºnk a HTML list√°n
                const allItems = document.querySelectorAll('.item-box');
                
                allItems.forEach(item => {
                    const id = item.getAttribute('data-id'); // "1.1.1"
                    const status = item.getAttribute('data-status'); // "OK", "NOK"
                    const uid = id.replace(/\./g, '_');
                    const comment = document.getElementById(`com-${uid}`).value;

                    // Munkalap kiv√°laszt√°sa
                    let sheetName = "";
                    if (id.startsWith("1.")) sheetName = "Checkpunkte"; // Vagy "Checkpunkte"
                    else if (id.startsWith("2.")) sheetName = "Visu-Detail"; // "Visu details" / "Visu-Detail"

                    // Munkalap keres√©se (figyelmen k√≠v√ºl hagyva a kis/nagybet≈±t)
                    const worksheet = workbook.worksheets.find(ws => 
                        ws.name.toLowerCase().includes(sheetName.toLowerCase().replace("-", " ")) || 
                        ws.name.toLowerCase().includes(sheetName.toLowerCase())
                    );

                    if (worksheet) {
                        // Megkeress√ºk a sort az 'A' oszlopban
                        let targetRow = null;
                        
                        worksheet.eachRow((row, rowNumber) => {
                            const cellA = row.getCell(1).value; // A oszlop
                            if (cellA && cellA.toString().trim() == id) {
                                targetRow = row;
                            }
                        });

                        if (targetRow) {
                            // Cella el√©r√©se (C=3, D=4, F=6)
                            const cellC = targetRow.getCell(3); // OK
                            const cellD = targetRow.getCell(4); // NOK
                            const cellF = targetRow.getCell(6); // Komment

                            // T√∂r√∂lj√ºk a kor√°bbi tartalmat (csak az √©rt√©ket, a st√≠lust nem!)
                            cellC.value = null;
                            cellD.value = null;
                            cellF.value = null;

                            if (status === "OK") {
                                cellC.value = "x";
                                cellC.alignment = { horizontal: 'center' }; // Opcion√°lis: k√∂z√©pre igaz√≠t√°s
                            } else if (status === "NOK") {
                                cellD.value = "x";
                                cellD.alignment = { horizontal: 'center' };
                            }

                            if (comment) {
                                cellF.value = comment;
                            }
                        }
                    }
                });

                // F√°jl ment√©se (blob gener√°l√°s)
                const outBuffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([outBuffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                saveAs(blob, `${devName}_Checklist_Kitoltott.xlsx`);
                
                alert("Sikeres ment√©s! A form√°z√°s megmaradt.");

            } catch (err) {
                console.error(err);
                alert("Hiba t√∂rt√©nt a f√°jl feldolgoz√°sa k√∂zben: " + err.message);
            }
        };

        reader.readAsArrayBuffer(file);
        input.value = ""; // Reset
    }

    render();
</script>

</body>
</html>
