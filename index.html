<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INTEGRA AUTO-EXPORT V16</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <style>
        /* --- ST√çLUSOK (S√ñT√âT T√âMA) --- */
        :root {
            --bg: #121212; --card: #1e1e1e; --primary: #00bcd4;
            --success: #00e676; --danger: #ff5252; --excel: #21a366; --text: #ffffff;
        }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; padding-bottom: 160px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        
        .row-group { display: flex; gap: 10px; }
        .input-group { margin-bottom: 15px; flex: 1; }
        .input-group label { color: var(--primary); font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 5px; }
        .input-group input { background: #2c2c2c; border: 1px solid #444; color: #fff; width: 100%; padding: 12px; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        
        .section-header { background: #252525; color: var(--primary); padding: 15px; font-weight: bold; margin-top: 30px; border-left: 4px solid var(--primary); border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; }
        .section-content { display: none; margin-top: 10px; }
        .section-content.active { display: block; }
        
        .item-box { background: var(--card); padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #333; position: relative; }
        .item-box[data-status="OK"] { border-left: 6px solid var(--success); }
        .item-box[data-status="NOK"] { border-left: 6px solid var(--danger); }
        
        .id-tag { background: #333; color: var(--primary); padding: 3px 6px; font-size: 0.75rem; border-radius: 4px; font-weight: bold; }
        .q-text { font-size: 1.05rem; margin: 12px 0; line-height: 1.4; font-weight: 500; }
        
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: #fff; transition: 0.2s; }
        .btn-guide { flex: 0 0 50px; background: #333; color: var(--primary); }
        .btn-ok { background: #1b5e20; opacity: 0.6; }
        .btn-nok { background: #b71c1c; opacity: 0.6; }
        .btn-ok.active { background: var(--success); color: #000; opacity: 1; transform: scale(1.02); }
        .btn-nok.active { background: var(--danger); color: #fff; opacity: 1; transform: scale(1.02); }
        
        .details { display: none; margin-top: 15px; border-top: 1px dashed #444; padding-top: 15px; }
        .guide-box { background: rgba(0,188,212,0.1); color: #ddd; padding: 12px; border-radius: 6px; margin-bottom: 15px; white-space: pre-line; border-left: 2px solid var(--primary); }
        textarea { width: 100%; background: #111; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 6px; min-height: 60px; }
        
        /* --- LEBEG≈ê L√ÅBL√âC --- */
        .floating-footer { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(30,30,30,0.98); border-top: 2px solid var(--primary); 
            padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 999; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .footer-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .score { font-size: 1.5rem; color: var(--primary); font-weight: bold; }
        
        .btn-action { padding: 12px; border-radius: 8px; font-weight: bold; border: none; font-size: 0.9rem; text-transform: uppercase; width: 100%; }
        .btn-pdf { background: #444; color: #fff; flex: 1; }
        .btn-auto { background: linear-gradient(45deg, #21a366, #00e676); color: #000; flex: 2; box-shadow: 0 0 10px rgba(0,230,118,0.3); }
        .btn-auto:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid #000; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Print Header */
        #print-header { display: none; }
        @media print {
            .floating-footer, .btn-guide, .btn-row button, .input-group, .subtitle, .row-group { display: none !important; }
            .card { border: none; padding: 0; }
            #print-header { display: block; border-bottom: 2px solid #000; margin-bottom: 20px; }
            .section-header { background: #eee !important; color: #000 !important; border: none !important; border-bottom: 1px solid #000 !important; }
            .section-content { display: block !important; }
            .item-box { border: none; border-bottom: 1px dotted #ccc; page-break-inside: avoid; color: #000; }
            .item-box[data-status="OK"]::after { content: "‚úî OK"; color: green; float: right; margin-top: -30px; font-weight: bold;}
            .item-box[data-status="NOK"]::after { content: "‚úñ NOK"; color: red; float: right; margin-top: -30px; font-weight: bold;}
        }
    </style>
</head>
<body>

<div id="print-header">
    <h1>INTEGRA JEGYZ≈êK√ñNYV</h1>
    <div style="display:flex; justify-content:space-between;">
        <span><strong>G√©p:</strong> <span id="p-dev">-</span></span>
        <span><strong>PLC:</strong> <span id="p-plc">-</span></span>
        <span><strong>Ellen≈ër:</strong> <span id="p-op">-</span></span>
        <span><strong>Eredm√©ny:</strong> <span id="p-score">0%</span></span>
    </div>
</div>

<div class="card">
    <h1 style="color:var(--primary); margin:0;">INTEGRA CHECKLIST v16</h1>
    <span class="subtitle" style="color:#888; font-size:0.9rem;">Fix: K√©pletek friss√≠t√©se</span>
    
    <div class="row-group">
        <div class="input-group" style="flex:2;">
            <label>BERENDEZ√âS NEVE (XXXX)</label>
            <input type="text" id="devName" placeholder="pl. SM31" oninput="syncData()">
        </div>
        <div class="input-group" style="flex:1;">
            <label>PLC SZ√ÅMA (SPSX)</label>
            <input type="number" id="plcNum" placeholder="pl. 1" oninput="syncData()">
        </div>
    </div>
    
    <div class="input-group">
        <label>ELLEN≈êR NEVE</label>
        <input type="text" id="opName" placeholder="N√©v..." oninput="syncData()">
    </div>
</div>

<div id="root"></div>

<div class="floating-footer">
    <div class="footer-row">
        <span style="color:#aaa; font-size:0.9rem;">√Ållapot: <span id="statusText" style="color:var(--primary)">K√©sz</span></span>
        <div class="score" id="scoreDisplay">0%</div>
    </div>
    <div class="footer-row">
        <button class="btn-action btn-pdf" onclick="window.print()">üìÑ PDF</button>
        <button class="btn-action btn-auto" id="btnExport" onclick="startAutoExport()">
            ‚òÅÔ∏è FORD√çT√ÅS √âS MENT√âS
        </button>
    </div>
</div>

<script>
    // --- KONFIGUR√ÅCI√ì ---
    // A GitHub Raw link
    const GITHUB_TEMPLATE_URL = "https://raw.githubusercontent.com/balazsnorberttt-prog/integra-checklist-files/main/DE_PCS_031_02_XXXX_SPSX_Visu%20Checkliste.xlsx";
    const TRANSLATE_API = "https://api.mymemory.translated.net/get";
    
    // --- ADATB√ÅZIS ---
    const data = [
        { cat: "1.1.0 H√ÅL√ìZAT", items: [
            { id: "1.1.1", t: "H√°l√≥zati telep√≠t√©s el≈ë√≠r√°s szerinti?", g: "Online topol√≥gi√°t megnyitni √©s ellen≈ërizni..." },
            { id: "1.1.2", t: "G√©pn√©v egyedi √©s egyeztetve?", g: "G√©pn√©v egyeztetve √©s egy√©rtelm≈±" },
            { id: "1.1.3", t: "Ondeso tool futott?", g: "Ondeso tool rendben fut rajta..." }
        ]},
        { cat: "1.2.0 SZOFTVER", items: [
            { id: "1.2.1", t: "Image Verzi√≥ aktu√°lis?", g: "OS-Info-t elind√≠tani..." },
            { id: "1.2.2", t: "TIA Portal verzi√≥ megfelel≈ë?", g: "TIA verzi√≥ ellen≈ërz√©s V16 UB" },
            { id: "1.2.3", t: "Safety verzi√≥ megfelel≈ë?", g: "TIA verzi√≥ ellen≈ërz√©s" },
            { id: "1.2.4", t: "Integra Designer verzi√≥?", g: "6.9.7.0 vagy ellen≈ërizni a g√©peket..." }
        ]},
        { cat: "1.3.0 HARDWARE", items: [
             { id: "1.3.1", t: "PC feliratozva?", g: "Pult jel√∂l√©s (Nyomtatva vagy grav√≠rozva)" }
        ]},
        { cat: "1.4.0 RENDSZER", items: [
            { id: "1.4.1", t: "Rendszerdiagnosztika hiba n√©lk√ºl?", g: "Integra System Manager..." },
            { id: "1.4.2", t: "IntegraCheck OK?", g: "VMC, Vizualiz√°ci√≥: Men√º/IntegraCheck" },
            { id: "1.4.3", t: "Mozg√°sk√©pek rendben?", g: "Minden Visu-ban ellen≈ërizni..." },
            { id: "1.4.4", t: "Interf√©sz k√©pek rendben?", g: "Mozg√°s k√©perny≈ë ikonja mellett..." },
            { id: "1.4.5", t: "Designer Templates OK?", g: "Ha a System z√∂ld, akkor j√≥..." },
            { id: "1.4.6", t: "Scriptek dokument√°lva?", g: "idPro projektet let√∂lteni..." },
            { id: "1.4.7", t: "Nyelv be√°ll√≠tva?", g: "Ellen≈ërizni a nyelvv√°lt√°st" }
        ]},
        { cat: "1.6.0 KIEG√âSZ√çT√âSEK", items: [
            { id: "1.6.1", t: "Mintaprojektek betartva?", g: "RB, MO, FT el≈ë√≠r√°sok" },
            { id: "1.6.2", t: "Tech param√©terek j√≥ helyen?", g: "D:\\CMWProjekt mappa" },
            { id: "1.6.3", t: "IntegraShell konfigur√°ci√≥?", g: "Tiltja a programok futtat√°s√°t..." },
            { id: "1.6.4", t: "EKM kapcsolat?", g: "Szerverr≈ël kapja..." },
            { id: "1.6.5", t: "isiSave be√°ll√≠tva?", g: "isiSave program ellen≈ërz√©s" },
            { id: "1.6.6", t: "Index-Szerver OK?", g: "Systemmanager online..." },
            { id: "1.6.8", t: "SIS Log tiszta?", g: "D:\\integra\\System\\Logs\\SisServer.csv" },
            { id: "1.6.9", t: "Mappastrukt√∫ra OK?", g: "CMWProjekt mappa fel√©p√≠t√©se" },
            { id: "1.6.10", t: "Szem√©t t√∂r√∂lve?", g: "Nincs m√°s TIA projekt" },
            { id: "1.6.11", t: "V√≠rusirt√≥ friss√ºl?", g: "Antiv√≠rus szoftver telep√≠tve" }
        ]},
        { cat: "2.1.0 PLC (SPS)", items: [
            { id: "2.1.1", t: "Minden PLC ter√ºlet l√°tszik?", g: "Ter√ºlet v√°laszt√≥ k√©perny≈ë" },
            { id: "2.1.2", t: "Minden ter√ºletnek van vizuja?", g: "SPS ter√ºlet vizualiz√°ci√≥" },
            { id: "2.1.3", t: "Full HD felbont√°s?", g: "Projekttervez≈ëben Full HD" },
            { id: "2.1.4", t: "Calibri 10 Bold?", g: "Bet≈±t√≠pus ellen≈ërz√©s" },
            { id: "2.1.5", t: "Pult 99 (Nyers) ablak?", g: "Helyettes√≠t≈ë ablak funkci√≥" },
            { id: "2.1.6", t: "PNG √°tl√°tsz√≥ k√©pek?", g: "Kb. 100 KB f√°jlm√©ret" }
        ]},
        { cat: "2.2.0 K√âPERNY≈êK", items: [
            { id: "2.2.1", t: "√Åttekint≈ë k√©pek OK?", g: "Szab√°lyzat szerint" },
            { id: "2.3.1", t: "Pult k√©pek OK?", g: "Szab√°lyzat szerint" },
            { id: "2.4.1", t: "√Ållom√°s k√©pek OK?", g: "Szab√°lyzat szerint" },
            { id: "2.5.1", t: "Speci√°lis funkci√≥k OK?", g: "Szab√°lyzat szerint" },
            { id: "2.5.3", t: "Betriebsfunktionen OK?", g: "Szab√°lyzat szerint" },
            { id: "2.5.4", t: "Robot √°ttekint≈ëk OK?", g: "Szab√°lyzat szerint" },
            { id: "2.6.0", t: "R√©szletk√©pek (Zusatz)", g: "Szab√°lyzat szerint" },
            { id: "2.6.1", t: "Nincs Station/Pult elem?", g: "Nincsenek magasabb szint≈± elemek" },
            { id: "2.6.2", t: "V√©szle√°ll√≠t√≥ (SonderBit)?", g: "DYN_GEN_SonderBit_Endlage_Absolut" },
            { id: "2.6.3", t: "R√©szletk√©pek OK?", g: "St√°ci√≥ r√©szletes k√©perny≈ë" }
        ]}
    ];

    // --- ALAP RENDER ---
    const root = document.getElementById('root');

    function render() {
        data.forEach((sect, idx) => {
            const h = document.createElement('div');
            h.className = 'section-header';
            h.innerHTML = `<span>${sect.cat}</span> <span>‚ñº</span>`;
            h.onclick = () => document.getElementById(`sec-${idx}`).classList.toggle('active');
            
            const c = document.createElement('div');
            c.className = 'section-content';
            c.id = `sec-${idx}`;
            if(idx === 0) c.classList.add('active'); 

            sect.items.forEach(item => {
                const uid = item.id.replace(/\./g, '_');
                c.innerHTML += `
                    <div class="item-box" id="box-${uid}" data-id="${item.id}">
                        <span class="id-tag">${item.id}</span>
                        <div class="q-text">${item.t}</div>
                        <div class="btn-row">
                            <button class="btn-guide" onclick="toggleDetails('${uid}')">?</button>
                            <button class="btn-ok" onclick="setStatus('${uid}', 'OK')">OK</button>
                            <button class="btn-nok" onclick="setStatus('${uid}', 'NOK')">NOK</button>
                        </div>
                        <div class="details" id="det-${uid}">
                            <div class="guide-box">${item.g}</div>
                            <textarea placeholder="Magyar megjegyz√©s..." id="com-${uid}"></textarea>
                        </div>
                    </div>
                `;
            });
            root.appendChild(h);
            root.appendChild(c);
        });
    }

    // --- FELHASZN√ÅL√ìI INTERAKCI√ìK ---
    function toggleDetails(uid) {
        const el = document.getElementById(`det-${uid}`);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function setStatus(uid, s) {
        const box = document.getElementById(`box-${uid}`);
        const btns = box.querySelectorAll('.btn-row button');
        btns[1].classList.remove('active');
        btns[2].classList.remove('active');
        box.setAttribute('data-status', s);

        if(s === 'OK') { btns[1].classList.add('active'); } 
        else { btns[2].classList.add('active'); document.getElementById(`det-${uid}`).style.display = 'block'; }
        calc();
    }

    function calc() {
        const all = document.querySelectorAll('.item-box').length;
        const ok = document.querySelectorAll('.item-box[data-status="OK"]').length;
        const pct = Math.round((ok/all)*100);
        document.getElementById('scoreDisplay').innerText = pct + "%";
        document.getElementById('p-score').innerText = pct + "%";
    }

    function syncData() {
        document.getElementById('p-dev').innerText = document.getElementById('devName').value;
        document.getElementById('p-plc').innerText = document.getElementById('plcNum').value;
        document.getElementById('p-op').innerText = document.getElementById('opName').value;
    }

    // --- FORD√çT√ÅS LOGIKA ---
    async function translateText(text) {
        if (!text || text.trim() === "") return "";
        try {
            const url = `${TRANSLATE_API}?q=${encodeURIComponent(text)}&langpair=hu|de`;
            const res = await fetch(url);
            const json = await res.json();
            if (json.responseData && json.responseData.translatedText) {
                return json.responseData.translatedText;
            }
            return text;
        } catch (e) {
            console.error("Ford√≠t√°si hiba:", e);
            return text;
        }
    }

    // --- AUTOMATIKUS EXPORT FOLYAMAT ---
    async function startAutoExport() {
        const devName = document.getElementById('devName').value;
        const plcNum = document.getElementById('plcNum').value;
        
        if(!devName || !plcNum) { 
            alert("K√©rlek t√∂ltsd ki a Berendez√©s nev√©t (XXXX) √©s a PLC sz√°m√°t!"); 
            return; 
        }

        const btn = document.getElementById('btnExport');
        const status = document.getElementById('statusText');

        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> LET√ñLT√âS...';
        status.innerText = "Sablon let√∂lt√©se...";

        try {
            // 1. Sablon let√∂lt√©se GitHub-r√≥l
            const response = await fetch(GITHUB_TEMPLATE_URL);
            if(!response.ok) throw new Error("Hiba a sablon let√∂lt√©sekor. Ellen≈ërizd az internetkapcsolatot!");
            const buffer = await response.arrayBuffer();

            // 2. Excel bet√∂lt√©se
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(buffer);

            // --- JAV√çT√ÅS: K√âPLETEK √öJRASZ√ÅMOL√ÅSA ---
            // Ez a sor k√©nyszer√≠ti az Excelt, hogy megnyit√°skor azonnal sz√°molja √∫jra a formul√°kat!
            workbook.calcProperties.fullCalcOnLoad = true;

            // 3. Adatok feldolgoz√°sa √©s ford√≠t√°s
            const allItems = document.querySelectorAll('.item-box');
            
            status.innerText = "Adatok √≠r√°sa & Ford√≠t√°s...";
            btn.innerHTML = '<div class="spinner"></div> FORD√çT√ÅS...';

            for (const item of allItems) {
                const id = item.getAttribute('data-id');
                const stat = item.getAttribute('data-status');
                const uid = id.replace(/\./g, '_');
                const hungarianComment = document.getElementById(`com-${uid}`).value;
                
                let germanComment = "";
                if(hungarianComment.length > 0) {
                    germanComment = await translateText(hungarianComment);
                }

                // Munkalap keres√©se
                let keywords = [];
                if (id.startsWith("1.")) keywords = ["Check", "punkte", "1"];
                else if (id.startsWith("2.")) keywords = ["Visu", "Detail", "2"];

                const worksheet = workbook.worksheets.find(ws => {
                    const name = ws.name.toLowerCase();
                    return keywords.some(k => name.includes(k.toLowerCase()));
                });

                if (worksheet) {
                    let targetRow = null;
                    worksheet.eachRow((row) => {
                        const cellA = row.getCell(1).value; 
                        if (cellA && cellA.toString().trim() == id) targetRow = row;
                    });

                    if (targetRow) {
                        const cellC = targetRow.getCell(3); // OK
                        const cellD = targetRow.getCell(4); // NOK
                        const cellF = targetRow.getCell(6); // Comment
                        
                        cellC.value = null; cellD.value = null; cellF.value = null;

                        if (stat === "OK") {
                            cellC.value = "x";
                            cellC.alignment = { horizontal: 'center' };
                        } else if (stat === "NOK") {
                            cellD.value = "x";
                            cellD.alignment = { horizontal: 'center' };
                        }

                        if (germanComment) {
                            cellF.value = germanComment;
                        }
                    }
                }
            }

            // 4. MENT√âS
            let finalFileName = "DE_PCS_031_02_XXXX_SPSX_Visu Checkliste.xlsx";
            finalFileName = finalFileName.replace("XXXX", devName);
            finalFileName = finalFileName.replace("SPSX", "SPS" + plcNum);

            btn.innerHTML = '<div class="spinner"></div> MENT√âS...';
            
            const outBuffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([outBuffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            
            const url = window.URL.createObjectURL(blob);
            const anchor = document.createElement("a");
            anchor.href = url;
            anchor.download = finalFileName; 
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
            
            status.innerText = "K√©sz!";
            alert(`Sikeres ment√©s!\nF√°jln√©v: ${finalFileName}\n\nTipp: Nyisd meg az Excelt, hogy l√°sd a friss√ºlt sz√°zal√©kokat!`);

        } catch (err) {
            console.error(err);
            alert("Hiba: " + err.message);
            status.innerText = "Hiba";
        } finally {
            btn.disabled = false;
            btn.innerHTML = '‚òÅÔ∏è FORD√çT√ÅS √âS MENT√âS';
        }
    }

    render();
</script>

</body>
</html>
