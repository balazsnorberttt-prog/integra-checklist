<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INTEGRA CHECKLIST V11 - EXCEL</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        /* --- ALAP ST√çLUSOK (S√ñT√âT M√ìD) --- */
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --primary: #00bcd4;  /* Neon K√©k */
            --success: #00e676;  /* Neon Z√∂ld */
            --danger: #ff5252;   /* Neon Piros */
            --excel: #21a366;    /* Excel Z√∂ld */
            --text: #ffffff;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            padding-bottom: 140px; /* Megn√∂velt hely a lebeg≈ë gomboknak */
        }

        /* --- K√ÅRTY√ÅK --- */
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        h1.app-title { 
            color: var(--primary); margin: 0; 
            text-transform: uppercase; font-size: 1.4rem; letter-spacing: 1px;
        }
        .subtitle { 
            color: #888; font-size: 0.9rem; margin-bottom: 20px; 
            display: block; border-bottom: 1px solid #333; padding-bottom: 10px; 
        }

        /* --- BEVITELI MEZ≈êK --- */
        .input-group { margin-bottom: 15px; }
        .input-group label { 
            color: var(--primary); font-size: 0.8rem; 
            font-weight: bold; display: block; margin-bottom: 5px; 
        }
        .input-group input { 
            background: #2c2c2c; border: 1px solid #444; color: #fff; 
            width: 100%; padding: 12px; border-radius: 6px; 
            font-size: 1rem; box-sizing: border-box; 
        }

        /* --- SZEKCI√ìK --- */
        .section-header {
            background: #252525; color: var(--primary); padding: 15px; 
            font-weight: bold; margin-top: 30px; 
            border-left: 4px solid var(--primary); border-radius: 8px; 
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .section-content { display: none; margin-top: 10px; }
        .section-content.active { display: block; }

        /* --- LISTA ELEMEK --- */
        .item-box {
            background: var(--card); padding: 15px; margin-bottom: 15px; 
            border-radius: 8px; border: 1px solid #333; position: relative;
        }
        .item-box[data-status="OK"] { border-left: 6px solid var(--success); }
        .item-box[data-status="NOK"] { border-left: 6px solid var(--danger); }

        .id-tag { 
            background: #333; color: var(--primary); padding: 3px 6px; 
            font-size: 0.75rem; border-radius: 4px; font-weight: bold; 
        }
        .q-text { font-size: 1.05rem; margin: 12px 0; line-height: 1.4; font-weight: 500; }

        /* --- GOMBOK --- */
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        button { 
            flex: 1; padding: 12px; border: none; border-radius: 6px; 
            font-weight: bold; cursor: pointer; color: #fff; font-size: 0.9rem;
            transition: opacity 0.2s;
        }
        .btn-guide { flex: 0 0 50px; background: #333; color: var(--primary); font-size: 1.2rem; }
        .btn-ok { background: #1b5e20; opacity: 0.6; }
        .btn-nok { background: #b71c1c; opacity: 0.6; }
        
        .btn-ok.active { background: var(--success); color: #000; opacity: 1; box-shadow: 0 0 10px rgba(0,230,118,0.4); }
        .btn-nok.active { background: var(--danger); color: #fff; opacity: 1; box-shadow: 0 0 10px rgba(255,82,82,0.4); }

        /* --- R√âSZLETEK (Leny√≠l√≥) --- */
        .details { display: none; margin-top: 15px; border-top: 1px dashed #444; padding-top: 15px; }
        .guide-box { 
            background: rgba(0,188,212,0.1); color: #ddd; padding: 12px; 
            border-radius: 6px; font-size: 0.9rem; margin-bottom: 15px; 
            white-space: pre-line; border-left: 2px solid var(--primary);
        }
        textarea { 
            width: 100%; background: #111; color: #fff; border: 1px solid #444; 
            padding: 10px; border-radius: 6px; box-sizing: border-box; min-height: 60px; font-family: inherit;
        }
        .file-upload { 
            display: block; background: #333; color: var(--primary); 
            padding: 12px; text-align: center; margin-top: 10px; 
            border-radius: 6px; border: 1px dashed #555; cursor: pointer;
        }
        .img-preview { width: 100%; max-height: 250px; object-fit: contain; margin-top: 10px; display: none; border: 1px solid #444; border-radius: 4px; }

        /* --- FIX L√ÅBL√âC --- */
        .floating-footer {
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(30,30,30,0.95); backdrop-filter: blur(5px);
            border-top: 2px solid var(--primary); padding: 15px; 
            display: flex; flex-direction: column; gap: 10px;
            z-index: 999;
        }
        .footer-row {
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }
        .score { font-size: 1.5rem; color: var(--primary); font-weight: bold; margin-left: 10px; }
        
        .btn-action { 
            padding: 10px 20px; border-radius: 30px; font-weight: bold; border: none; font-size: 0.9rem; text-transform: uppercase;
        }
        .btn-pdf { background: var(--primary); color: #000; }
        .btn-excel { background: var(--excel); color: #fff; position: relative; overflow: hidden; }

        #excelInput { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* --- NYOMTAT√ÅS / PDF SPECIALISTA ST√çLUSOK --- */
        #print-header { display: none; }

        @media print {
            @page { margin: 15mm; size: A4; }
            
            body { 
                background: #fff; color: #000; padding: 0; margin: 0; 
                font-family: Arial, sans-serif; font-size: 11px;
            }

            /* Elemek elrejt√©se */
            .floating-footer, .btn-guide, .file-upload, .btn-row button { display: none !important; }
            .subtitle, .section-header span:last-child { display: none; }
            .input-group { display: none; } 
            .card { border: none; box-shadow: none; margin: 0; padding: 0; background: none; color: #000; }

            /* Fejl√©c megjelen√≠t√©se */
            #print-header { 
                display: block; border-bottom: 2px solid #000; 
                margin-bottom: 20px; padding-bottom: 10px; 
            }
            #print-header h1 { font-size: 18px; color: #000; margin-bottom: 10px; text-align: center; }
            .meta-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 2px;}

            /* Szekci√≥k */
            .section-header { 
                background: #eee !important; color: #000 !important; 
                margin: 20px 0 10px 0 !important; padding: 5px 10px !important;
                border: none !important; border-bottom: 1px solid #000 !important; 
                border-radius: 0 !important; font-size: 12px !important; 
                page-break-after: avoid; 
            }
            .section-content { display: block !important; margin: 0; }

            /* Lista elemek */
            .item-box {
                border: none; border-bottom: 1px dotted #ccc; 
                margin: 0; padding: 10px 0; 
                border-radius: 0; background: none; 
                page-break-inside: avoid; 
            }

            .id-tag { background: none; color: #000; border: 1px solid #000; padding: 1px 4px; font-size: 10px; }
            .q-text { margin: 5px 0; font-weight: bold; font-size: 11px; color: #000; }

            /* St√°tusz ki√≠r√°sa */
            .item-box::after {
                display: block; float: right; font-weight: bold; font-size: 11px; margin-top: -30px;
            }
            .item-box[data-status="OK"]::after { content: "‚úî MEGFELEL≈ê"; color: green; }
            .item-box[data-status="NOK"]::after { content: "‚úñ HIB√ÅS"; color: red; }
            .item-box:not([data-status])::after { content: "‚óã √úRES"; color: #999; }

            /* R√©szletek */
            .guide-box { display: none; }
            .details { display: block !important; border: none; margin: 0; padding: 0; }
            textarea { 
                border: none; background: none; color: #000; padding: 0; 
                font-style: italic; min-height: auto; font-size: 11px;
                display: block; width: 100%; resize: none;
            }
            .img-preview { display: block; max-height: 150px; max-width: 200px; border: 1px solid #ccc; margin-top: 5px; }
        }
    </style>
</head>
<body>

<div id="print-header">
    <h1>INTEGRA ELLEN≈êRZ√âSI JEGYZ≈êK√ñNYV</h1>
    <div class="meta-row">
        <span><strong>Berendez√©s:</strong> <span id="p-dev">-</span></span>
        <span><strong>D√°tum:</strong> <span id="p-date">-</span></span>
    </div>
    <div class="meta-row">
        <span><strong>Ellen≈ër:</strong> <span id="p-op">-</span></span>
        <span><strong>Eredm√©ny:</strong> <span id="p-score">0%</span></span>
    </div>
</div>

<div class="card">
    <h1 class="app-title">Integra Checklist v11</h1>
    <span class="subtitle">Excel Import/Export Verzi√≥</span>
    
    <div class="input-group">
        <label>BERENDEZ√âS NEVE</label>
        <input type="text" id="devName" placeholder="pl. OP10" oninput="syncData()">
    </div>
    <div class="input-group">
        <label>ELLEN≈êR NEVE</label>
        <input type="text" id="opName" placeholder="N√©v..." oninput="syncData()">
    </div>
</div>

<div id="root"></div>

<div class="floating-footer">
    <div class="footer-row">
        <span style="color:#aaa; font-size:0.8rem;">Eredm√©ny:</span>
        <div class="score" id="scoreDisplay">0%</div>
    </div>
    <div class="footer-row">
        <button class="btn-action btn-pdf" onclick="savePDF()">üìÑ PDF</button>
        <button class="btn-action btn-excel">
            üìó EXCEL KIT√ñLT√âS
            <input type="file" id="excelInput" accept=".xlsx, .xls" onchange="handleExcelUpload(this)">
        </button>
    </div>
</div>

<script>
    // --- ADATB√ÅZIS (V√ÅLTOZATLAN) ---
    const data = [
        { cat: "1.1.0 H√ÅL√ìZAT", items: [
            { id: "1.1.1", t: "H√°l√≥zati telep√≠t√©s el≈ë√≠r√°s szerinti?", g: "Online topol√≥gi√°t megnyitni √©s ellen≈ërizni..." },
            { id: "1.1.2", t: "G√©pn√©v egyedi √©s egyeztetve?", g: "G√©pn√©v egyeztetve √©s egy√©rtelm≈±" },
            { id: "1.1.3", t: "Ondeso tool futott?", g: "Ondeso tool rendben fut rajta..." }
        ]},
        { cat: "1.2.0 SZOFTVER", items: [
            { id: "1.2.1", t: "Image Verzi√≥ aktu√°lis?", g: "OS-Info-t elind√≠tani..." },
            { id: "1.2.2", t: "TIA Portal verzi√≥ megfelel≈ë?", g: "TIA verzi√≥ ellen≈ërz√©s V16 UB" },
            { id: "1.2.3", t: "Safety verzi√≥ megfelel≈ë?", g: "TIA verzi√≥ ellen≈ërz√©s" },
            { id: "1.2.4", t: "Integra Designer verzi√≥?", g: "6.9.7.0 vagy ellen≈ërizni a g√©peket..." }
        ]},
        { cat: "1.3.0 HARDWARE", items: [
             { id: "1.3.1", t: "PC feliratozva?", g: "Pult jel√∂l√©s (Nyomtatva vagy grav√≠rozva)" }
        ]},
        { cat: "1.4.0 RENDSZER", items: [
            { id: "1.4.1", t: "Rendszerdiagnosztika hiba n√©lk√ºl?", g: "Integra System Manager..." },
            { id: "1.4.2", t: "IntegraCheck OK?", g: "VMC, Vizualiz√°ci√≥: Men√º/IntegraCheck" },
            { id: "1.4.3", t: "Mozg√°sk√©pek rendben?", g: "Minden Visu-ban ellen≈ërizni..." },
            { id: "1.4.4", t: "Interf√©sz k√©pek rendben?", g: "Mozg√°s k√©perny≈ë ikonja mellett..." },
            { id: "1.4.5", t: "Designer Templates OK?", g: "Ha a System z√∂ld, akkor j√≥..." },
            { id: "1.4.6", t: "Scriptek dokument√°lva?", g: "idPro projektet let√∂lteni..." },
            { id: "1.4.7", t: "Nyelv be√°ll√≠tva?", g: "Ellen≈ërizni a nyelvv√°lt√°st" }
        ]},
        { cat: "1.6.0 KIEG√âSZ√çT√âSEK", items: [
            { id: "1.6.1", t: "Mintaprojektek betartva?", g: "RB, MO, FT el≈ë√≠r√°sok" },
            { id: "1.6.2", t: "Tech param√©terek j√≥ helyen?", g: "D:\\CMWProjekt mappa" },
            { id: "1.6.3", t: "IntegraShell konfigur√°ci√≥?", g: "Tiltja a programok futtat√°s√°t..." },
            { id: "1.6.4", t: "EKM kapcsolat?", g: "Szerverr≈ël kapja..." },
            { id: "1.6.5", t: "isiSave be√°ll√≠tva?", g: "isiSave program ellen≈ërz√©s" },
            { id: "1.6.6", t: "Index-Szerver OK?", g: "Systemmanager online..." },
            { id: "1.6.8", t: "SIS Log tiszta?", g: "D:\\integra\\System\\Logs\\SisServer.csv" },
            { id: "1.6.9", t: "Mappastrukt√∫ra OK?", g: "CMWProjekt mappa fel√©p√≠t√©se" },
            { id: "1.6.10", t: "Szem√©t t√∂r√∂lve?", g: "Nincs m√°s TIA projekt" },
            { id: "1.6.11", t: "V√≠rusirt√≥ friss√ºl?", g: "Antiv√≠rus szoftver telep√≠tve" }
        ]},
        { cat: "2.1.0 PLC (SPS)", items: [
            { id: "2.1.1", t: "Minden PLC ter√ºlet l√°tszik?", g: "Ter√ºlet v√°laszt√≥ k√©perny≈ë" },
            { id: "2.1.2", t: "Minden ter√ºletnek van vizuja?", g: "SPS ter√ºlet vizualiz√°ci√≥" },
            { id: "2.1.3", t: "Full HD felbont√°s?", g: "Projekttervez≈ëben Full HD" },
            { id: "2.1.4", t: "Calibri 10 Bold?", g: "Bet≈±t√≠pus ellen≈ërz√©s" },
            { id: "2.1.5", t: "Pult 99 (Nyers) ablak?", g: "Helyettes√≠t≈ë ablak funkci√≥" },
            { id: "2.1.6", t: "PNG √°tl√°tsz√≥ k√©pek?", g: "Kb. 100 KB f√°jlm√©ret" }
        ]},
        { cat: "2.2.0 K√âPERNY≈êK", items: [
            { id: "2.2.1", t: "√Åttekint≈ë k√©pek OK?", g: "Szab√°lyzat szerint" },
            { id: "2.3.1", t: "Pult k√©pek OK?", g: "Szab√°lyzat szerint" },
            { id: "2.4.1", t: "√Ållom√°s k√©pek OK?", g: "Szab√°lyzat szerint" },
            { id: "2.5.1", t: "Speci√°lis funkci√≥k OK?", g: "Szab√°lyzat szerint" },
            { id: "2.5.3", t: "Betriebsfunktionen OK?", g: "Szab√°lyzat szerint" },
            { id: "2.5.4", t: "Robot √°ttekint≈ëk OK?", g: "Szab√°lyzat szerint" },
            { id: "2.6.0", t: "R√©szletk√©pek (Zusatz)", g: "Szab√°lyzat szerint" },
            { id: "2.6.1", t: "Nincs Station/Pult elem?", g: "Nincsenek magasabb szint≈± elemek" },
            { id: "2.6.2", t: "V√©szle√°ll√≠t√≥ (SonderBit)?", g: "DYN_GEN_SonderBit_Endlage_Absolut" },
            { id: "2.6.3", t: "R√©szletk√©pek OK?", g: "St√°ci√≥ r√©szletes k√©perny≈ë" }
        ]}
    ];

    const root = document.getElementById('root');
    let uploadedWorkbook = null;

    function render() {
        data.forEach((sect, idx) => {
            const h = document.createElement('div');
            h.className = 'section-header';
            h.innerHTML = `<span>${sect.cat}</span> <span>‚ñº</span>`;
            h.onclick = () => document.getElementById(`sec-${idx}`).classList.toggle('active');
            
            const c = document.createElement('div');
            c.className = 'section-content';
            c.id = `sec-${idx}`;
            if(idx === 0) c.classList.add('active'); 

            sect.items.forEach(item => {
                const uid = item.id.replace(/\./g, '_');
                c.innerHTML += `
                    <div class="item-box" id="box-${uid}" data-id="${item.id}">
                        <span class="id-tag">${item.id}</span>
                        <div class="q-text">${item.t}</div>
                        
                        <div class="btn-row">
                            <button class="btn-guide" onclick="toggleDetails('${uid}')">?</button>
                            <button class="btn-ok" onclick="setStatus('${uid}', 'OK')">OK</button>
                            <button class="btn-nok" onclick="setStatus('${uid}', 'NOK')">NOK</button>
                        </div>

                        <div class="details" id="det-${uid}">
                            <div class="guide-box">${item.g}</div>
                            <textarea placeholder="Megjegyz√©s √≠r√°sa..." id="com-${uid}"></textarea>
                            <label class="file-upload">
                                üì∑ K√©p csatol√°sa
                                <input type="file" accept="image/*" style="display:none" onchange="loadImg(event, '${uid}')">
                            </label>
                            <img id="img-${uid}" class="img-preview">
                        </div>
                    </div>
                `;
            });
            root.appendChild(h);
            root.appendChild(c);
        });
        document.getElementById('p-date').innerText = new Date().toLocaleString();
    }

    function toggleDetails(uid) {
        const el = document.getElementById(`det-${uid}`);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function setStatus(uid, s) {
        const box = document.getElementById(`box-${uid}`);
        const btns = box.querySelectorAll('.btn-row button');
        
        btns[1].classList.remove('active');
        btns[2].classList.remove('active');

        box.setAttribute('data-status', s);

        if(s === 'OK') {
            btns[1].classList.add('active');
        } else {
            btns[2].classList.add('active');
            document.getElementById(`det-${uid}`).style.display = 'block';
        }
        calc();
    }

    function loadImg(e, uid) {
        const img = document.getElementById(`img-${uid}`);
        if(e.target.files && e.target.files[0]){
            img.src = URL.createObjectURL(e.target.files[0]);
            img.style.display = 'block';
            document.getElementById(`det-${uid}`).style.display = 'block';
        }
    }

    function calc() {
        const all = document.querySelectorAll('.item-box').length;
        const ok = document.querySelectorAll('.item-box[data-status="OK"]').length;
        const pct = Math.round((ok/all)*100);
        document.getElementById('scoreDisplay').innerText = pct + "%";
        document.getElementById('p-score').innerText = pct + "%";
    }

    function syncData() {
        document.getElementById('p-dev').innerText = document.getElementById('devName').value;
        document.getElementById('p-op').innerText = document.getElementById('opName').value;
    }

    function savePDF() {
        const name = document.getElementById('devName').value;
        if(!name) { alert("K√©rlek add meg a g√©p nev√©t!"); return; }
        document.title = name + "_Jegyzokonyv";
        syncData();
        
        document.querySelectorAll('.section-content').forEach(el => el.classList.add('active'));
        window.print();
    }

    // --- EXCEL LOGIKA ---

    async function handleExcelUpload(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            // Beolvassuk a munkaf√ºzetet
            uploadedWorkbook = XLSX.read(data, {type: 'array'});
            
            // Azonnal feldolgozzuk √©s let√∂ltj√ºk
            processAndDownloadExcel(file.name);
        };
        reader.readAsArrayBuffer(file);
        
        // Input resetel√©se, hogy ugyanazt a f√°jlt √∫jra ki lehessen v√°lasztani jav√≠t√°s ut√°n
        input.value = "";
    }

    function processAndDownloadExcel(originalName) {
        if(!uploadedWorkbook) {
            alert("Hiba t√∂rt√©nt a beolvas√°skor!");
            return;
        }

        const devName = document.getElementById('devName').value || "Gep";

        // V√©gigmegy√ºnk az √∂sszes ellen≈ërz√©si ponton a HTML-ben
        const allItems = document.querySelectorAll('.item-box');
        
        allItems.forEach(item => {
            const id = item.getAttribute('data-id'); // pl "1.1.1" vagy "2.5.3"
            const status = item.getAttribute('data-status'); // "OK" vagy "NOK" vagy null
            const uid = id.replace(/\./g, '_');
            const comment = document.getElementById(`com-${uid}`).value;

            // 1. Melyik munkalapra √≠rjunk?
            // "Checkpunkte" (1.x.x) vagy "Visu-Detail" (2.x.x)
            let sheetName = "";
            if (id.startsWith("1.")) {
                sheetName = "Checkpunkte";
            } else if (id.startsWith("2.")) {
                sheetName = "Visu-Detail";
            }

            const worksheet = uploadedWorkbook.Sheets[sheetName];
            
            if (worksheet) {
                // 2. Megkeress√ºk, melyik sorban van az ID az "A" oszlopban
                // A SheetJS egy tartom√°nyt ad vissza (pl A1:F100), ezen kell v√©gigmenni
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                
                let foundRow = -1;

                // V√©gigiter√°lunk a sorokon az adott oszlopban (C=0 azaz A oszlop)
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    const cellRef = XLSX.utils.encode_cell({c: 0, r: R}); // A oszlop, R sor
                    const cell = worksheet[cellRef];
                    
                    // Ha a cella tartalma megegyezik az ID-vel (sz√≥k√∂z√∂ket lev√°gva)
                    if (cell && String(cell.v).trim() == id) {
                        foundRow = R;
                        break;
                    }
                }

                // 3. Ha megvan a sor, be√≠rjuk az adatokat
                if (foundRow !== -1) {
                    // C oszlop indexe = 2, D oszlop = 3, F oszlop = 5
                    
                    const cellC = XLSX.utils.encode_cell({c: 2, r: foundRow}); // OK
                    const cellD = XLSX.utils.encode_cell({c: 3, r: foundRow}); // NOK
                    const cellF = XLSX.utils.encode_cell({c: 5, r: foundRow}); // Comment

                    // El≈ësz√∂r t√∂r√∂lj√ºk a tartalmat (hogy ne maradjon bent el≈ëz≈ë szem√©t)
                    worksheet[cellC] = {v: "", t: 's'};
                    worksheet[cellD] = {v: "", t: 's'};
                    
                    if (status === "OK") {
                        worksheet[cellC] = {v: "x", t: 's'};
                    } else if (status === "NOK") {
                        worksheet[cellD] = {v: "x", t: 's'};
                    }

                    // Megjegyz√©s be√≠r√°sa, ha van
                    if (comment) {
                        worksheet[cellF] = {v: comment, t: 's'};
                    }
                }
            }
        });

        // 4. Ments√ºk le az √∫j f√°jlt
        XLSX.writeFile(uploadedWorkbook, `${devName}_Checklist_Export.xlsx`);
    }

    render();
</script>

</body>
</html>
