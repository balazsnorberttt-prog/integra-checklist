<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INTEGRA CHECKLIST V18</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <style>
        /* --- ST√çLUSOK (S√ñT√âT T√âMA) --- */
        :root {
            --bg: #121212; --card: #1e1e1e; --primary: #00bcd4;
            --success: #00e676; --danger: #ff5252; --excel: #21a366; --text: #ffffff;
        }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; padding-bottom: 160px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        
        .row-group { display: flex; gap: 10px; }
        .input-group { margin-bottom: 15px; flex: 1; }
        .input-group label { color: var(--primary); font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 5px; }
        .input-group input { background: #2c2c2c; border: 1px solid #444; color: #fff; width: 100%; padding: 12px; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        
        .section-header { background: #252525; color: var(--primary); padding: 15px; font-weight: bold; margin-top: 30px; border-left: 4px solid var(--primary); border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; }
        .section-content { display: none; margin-top: 10px; }
        .section-content.active { display: block; }
        
        .item-box { background: var(--card); padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #333; position: relative; transition: all 0.3s; }
        .item-box[data-status="OK"] { border-left: 6px solid var(--success); }
        .item-box[data-status="NOK"] { border-left: 6px solid var(--danger); }
        
        .id-tag { background: #333; color: var(--primary); padding: 3px 6px; font-size: 0.75rem; border-radius: 4px; font-weight: bold; }
        .q-text { font-size: 1.05rem; margin: 12px 0; line-height: 1.4; font-weight: 500; }
        
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: #fff; transition: 0.2s; }
        .btn-guide { flex: 0 0 50px; background: #333; color: var(--primary); }
        .btn-photo { flex: 0 0 50px; background: #444; color: #fff; position: relative; }
        .btn-ok { background: #1b5e20; opacity: 0.6; }
        .btn-nok { background: #b71c1c; opacity: 0.6; }
        .btn-ok.active { background: var(--success); color: #000; opacity: 1; transform: scale(1.02); }
        .btn-nok.active { background: var(--danger); color: #fff; opacity: 1; transform: scale(1.02); }
        
        .details { display: none; margin-top: 15px; border-top: 1px dashed #444; padding-top: 15px; }
        
        .guide-box { 
            background: rgba(0,188,212,0.1); 
            color: #e0e0e0; 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 15px; 
            white-space: pre-wrap;
            border-left: 2px solid var(--primary); 
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        textarea { width: 100%; background: #111; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 6px; min-height: 60px; box-sizing: border-box; font-family: sans-serif; }
        
        /* --- FOT√ì MODUL --- */
        .photo-section { display: none; margin-top: 15px; border-top: 1px solid #444; padding-top: 10px; }
        .photo-preview { width: 100%; max-height: 200px; object-fit: contain; background: #000; border-radius: 6px; margin-bottom: 10px; display: none; }
        .photo-input { display: none; }
        .btn-has-photo { background: var(--primary) !important; color: #000 !important; }
        
        /* --- LEBEG≈ê L√ÅBL√âC --- */
        .floating-footer { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(30,30,30,0.98); border-top: 2px solid var(--primary); 
            padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 999; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .footer-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .score { font-size: 1.5rem; color: var(--primary); font-weight: bold; }
        
        .btn-action { padding: 12px; border-radius: 8px; font-weight: bold; border: none; font-size: 0.9rem; text-transform: uppercase; width: 100%; }
        .btn-pdf { background: #fff; color: #000; flex: 1; }
        .btn-auto { background: linear-gradient(45deg, #21a366, #00e676); color: #000; flex: 2; box-shadow: 0 0 10px rgba(0,230,118,0.3); }
        .btn-auto:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid #000; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- PDF LAYOUT --- */
        #print-container { display: none; }
        @media print {
            body * { visibility: hidden; }
            .floating-footer, .card, #root, .section-header { display: none !important; }
            body { background: #fff; color: #000; padding: 0; margin: 0; -webkit-print-color-adjust: exact; }
            #print-container, #print-container * { visibility: visible; display: block; }
            #print-container { position: absolute; left: 0; top: 0; width: 100%; font-family: 'Helvetica', 'Arial', sans-serif; }
            .report-header { border-bottom: 2px solid #00bcd4; padding-bottom: 10px; margin-bottom: 20px; display: flex !important; justify-content: space-between; align-items: flex-end; }
            .report-title { font-size: 24px; font-weight: bold; color: #333; margin: 0; }
            .report-meta { font-size: 12px; color: #666; text-align: right; }
            .report-summary { display: flex !important; gap: 20px; margin-bottom: 30px; background: #f0f0f0; padding: 15px; border-radius: 8px; }
            .sum-item { flex: 1; text-align: center; }
            .sum-val { font-size: 18px; font-weight: bold; }
            .sum-lbl { font-size: 10px; text-transform: uppercase; color: #777; }
            .report-block { margin-bottom: 25px; border: 1px solid #ddd; border-radius: 6px; padding: 15px; page-break-inside: avoid; break-inside: avoid; background: #fff; }
            .rb-header { display: flex !important; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; }
            .rb-id { font-weight: bold; color: #00bcd4; }
            .rb-status { font-weight: bold; text-transform: uppercase; }
            .rb-status.OK { color: #008000; }
            .rb-status.NOK { color: #cc0000; }
            .rb-text { font-size: 14px; margin-bottom: 5px; font-weight: bold; }
            .rb-comment { font-size: 12px; font-style: italic; color: #555; margin-top: 5px; }
            .rb-photo-row { display: flex !important; gap: 15px; margin-top: 10px; align-items: flex-start; border-top: 1px dotted #ccc; padding-top: 10px; }
            .rb-img { width: 140px; height: 100px; object-fit: contain; border: 1px solid #eee; background: #fafafa; }
            .rb-desc { flex: 1; font-size: 11px; color: #333; }
            .rb-desc-label { font-weight: bold; display: block; margin-bottom: 3px; color: #00bcd4; }
        }
    </style>
</head>
<body>

<div class="card">
    <h1 style="color:var(--primary); margin:0;">INTEGRA CHECKLIST v18</h1>
    <span class="subtitle" style="color:#888; font-size:0.9rem;">PDF + EXCEL GENER√ÅTOR</span>
    
    <div class="row-group">
        <div class="input-group" style="flex:2;">
            <label>BERENDEZ√âS NEVE (XXXX)</label>
            <input type="text" id="devName" placeholder="pl. SM31" oninput="syncData()">
        </div>
        <div class="input-group" style="flex:1;">
            <label>PLC SZ√ÅMA (SPSX)</label>
            <input type="number" id="plcNum" placeholder="pl. 1" oninput="syncData()">
        </div>
    </div>
    
    <div class="input-group">
        <label>ELLEN≈êR NEVE</label>
        <input type="text" id="opName" placeholder="N√©v..." oninput="syncData()">
    </div>
</div>

<div id="root"></div>

<div class="floating-footer">
    <div class="footer-row">
        <span style="color:#aaa; font-size:0.9rem;">√Ållapot: <span id="statusText" style="color:var(--primary)">K√©sz</span></span>
        <div class="score" id="scoreDisplay">0%</div>
    </div>
    <div class="footer-row">
        <button class="btn-action btn-pdf" onclick="generateModernPDF()">üìÑ PDF</button>
        <button class="btn-action btn-auto" id="btnExport" onclick="startAutoExport()">
            ‚òÅÔ∏è EXCEL MENT√âS
        </button>
    </div>
</div>

<div id="print-container"></div>

<script>
    // --- KONFIGUR√ÅCI√ì ---
    const GITHUB_TEMPLATE_URL = "https://raw.githubusercontent.com/balazsnorberttt-prog/integra-checklist-files/main/DE_PCS_031_02_XXXX_SPSX_Visu%20Checkliste.xlsx";
    const TRANSLATE_API = "https://api.mymemory.translated.net/get";
    
    const photoStore = {};

    // --- ADATB√ÅZIS ---
    const data = [
        { cat: "1.1.0 H√ÅL√ìZAT", items: [
            { id: "1.1.1", t: "H√°l√≥zati telep√≠t√©s el≈ë√≠r√°s szerinti?", g: "Megfelel≈ë-e a h√°l√≥zati telep√≠t√©s az el≈ë√≠r√°soknak?\n\n- Windows PC-k, amelyek I/O modulokkal egy h√°zban tal√°lhat√≥k, utols√≥ r√©sztvev≈ëk√©nt csatlakozhatnak (EBF, HVO, ‚Ä¶).\n- Tov√°bbi kezel≈ë sz√°m√≠t√≥g√©peket (EBF, TBR) k√∂zvetlen√ºl egy olyan Switch-re kell csatlakoztatni, amely az Automation Access Switch portb≈ëv√≠t√©s√©re szolg√°l (pl. XC200 switch a +H111 √°llom√°sszekr√©nyben), vagy k√∂zvetlen√ºl az Automation-Access-Switch-re." },
            { id: "1.1.2", t: "G√©pn√©v egyedi √©s egyeztetve?", g: "Egy√©rtelm≈± a sz√°m√≠t√≥g√©p neve √©s egyeztetve lett?\n\n- Windows PC-k I/O modulokkal azonos h√°zban utols√≥ r√©sztvev≈ëk√©nt csatlakozhatnak." },
            { id: "1.1.3", t: "Ondeso tool futott?", g: "Az 'Ondeso' eszk√∂z megfelel≈ëen lett futtatva?\n\n- H√°l√≥zat √©s sz√°m√≠t√≥g√©pn√©v, illetve tartom√°ny (Domain) illeszt√©se.\n- Illeszt√©s a szerverrendszerekhez." }
        ]},
        { cat: "1.2.0 SZOFTVER", items: [
            { id: "1.2.1", t: "Image Verzi√≥ aktu√°lis?", g: "Melyik Image Verzi√≥ (IT Image PN) van telep√≠tve, √©s ez aktu√°lis-e?\n\nEllen≈ërz√©s helye: D:\\Tools\\OS-Info" },
            { id: "1.2.2", t: "TIA Portal verzi√≥ megfelel≈ë?", g: "A SIMATIC STEP7 Professional (TIA-Portal) verzi√≥ja megfelel az el≈ë√≠r√°snak?\n\nL√°sd: 000_B3.26.03_Projektierversion-Profinet-Komponenten_V60.xx.xls" },
            { id: "1.2.3", t: "Safety verzi√≥ megfelel≈ë?", g: "A SIMATIC STEP7 Safety (TIA-Portal) verzi√≥ja megfelel az el≈ë√≠r√°snak?\n\nL√°sd: 000_B3.26.03_Projektierversion-Profinet-Komponenten_V60.xx.xls" },
            { id: "1.2.4", t: "Integra Designer verzi√≥?", g: "Melyik Integra Designer verzi√≥ van telep√≠tve, √©s megfelel-e az el≈ë√≠r√°snak?" }
        ]},
        { cat: "1.3.0 HARDWARE", items: [
             { id: "1.3.1", t: "PC feliratozva?", g: "Fel van iratozva a PC n√©vvel?\nMegfelel a vizualiz√°ci√≥ fel√©p√≠t√©se √©s telep√≠t√©se az aktu√°lis el≈ë√≠r√°soknak?" }
        ]},
        { cat: "1.4.0 RENDSZER", items: [
            { id: "1.4.1", t: "Rendszerdiagnosztika hiba n√©lk√ºl?", g: "Nincsenek hib√°k a rendszer√°ttekint≈ë berendez√©s-diagnosztik√°ban (System√ºbersicht Anlagendiagnose)?" },
            { id: "1.4.2", t: "IntegraCheck OK?", g: "Rendszer√°ttekint≈ë berendez√©s-diagnosztika:\nRendben van az IntegraCheck?" },
            { id: "1.4.3", t: "Mozg√°sk√©pek rendben?", g: "Megvannak a mozg√°sk√©pek (Bewegungsbilder) √©s megfelelnek az el≈ë√≠r√°snak?" },
            { id: "1.4.4", t: "Interf√©sz k√©pek rendben?", g: "Megvannak az interf√©sz k√©pek (Schnittstellenbilder) √©s megfelelnek az el≈ë√≠r√°snak?" },
            { id: "1.4.5", t: "Designer Templates OK?", g: "Nem lettek m√≥dos√≠tva az aktu√°lis Designer sablonok (Templates), Designer modulok √©s a SystemTemplates.zip f√°jl?" },
            { id: "1.4.6", t: "Scriptek dokument√°lva?", g: "Haszn√°ltak szkripteket a Designer projektben, √©s ezek dokument√°lva vannak?" },
            { id: "1.4.7", t: "Nyelv be√°ll√≠tva?", g: "A vizualiz√°ci√≥ nyelvi be√°ll√≠t√°sai a tervez√©s megkezd√©se el≈ëtt m√≥dos√≠tva lettek?" }
        ]},
        { cat: "1.5.0 VISU - PROJEKTIERUNG", items: [
             { id: "1.5.1", t: "L√°sd Visu - Detail", g: "L√°sd a r√©szletes vizualiz√°ci√≥s ellen≈ërz≈ëlist√°t (Visu - Detail)." }
        ]},
        { cat: "1.6.0 KIEG√âSZ√çT√âSEK", items: [
            { id: "1.6.1", t: "Mintaprojektek betartva?", g: "Figyelembe vett√©k a mintaprojektek (RB, MO, FT) el≈ë√≠r√°sait √©s a rendelkez√©sre bocs√°tott sablonokat a megbesz√©l√©sek szerint?" },
            { id: "1.6.2", t: "Tech param√©terek j√≥ helyen?", g: "Minden technol√≥giai param√©ter / program az el≈ë√≠rt k√∂nyvt√°rakban van t√°rolva?\n(Pl. D:\\CMWProjects mappa)" },
            { id: "1.6.3", t: "IntegraShell konfigur√°ci√≥?", g: "Helyesen indul el az IntegraShell, √©s minden megfelel≈ëen van konfigur√°lva?" },
            { id: "1.6.4", t: "EKM kapcsolat?", g: "Helyesen van konfigur√°lva a hozz√°f√©r√©s-v√©delem?\n(Kapcsolat az EKM szerverhez)" },
            { id: "1.6.5", t: "isiSave be√°ll√≠tva?", g: "Helyesen van konfigur√°lva az archiv√°l√≥ szerver, √©s a felhaszn√°l√≥i adatok ment√©sre ker√ºltek?\n(Kapcsolat ISI-Save, ISI-Save CMW)" },
            { id: "1.6.6", t: "Index-Szerver OK?", g: "Helyesen van be√°ll√≠tva az Index-Szerver?" },
            { id: "1.6.7", t: "DFI-Szerver OK?", g: "Helyesen van be√°ll√≠tva a DFI-Szerver?" },
            { id: "1.6.8", t: "SIS Log tiszta?", g: "Vannak hiba√ºzenetek a SIS-Szerver napl√≥f√°jljaiban (Log-f√°jlok)?\n(D:\\integra\\System\\Logs\\SisServer.csv)" },
            { id: "1.6.9", t: "Mappastrukt√∫ra OK?", g: "A k√∂nyvt√°rszerkezet az el≈ë√≠r√°soknak megfelel≈ëen lett l√©trehozva, √©s a projektek ennek megfelel≈ëen vannak t√°rolva?\nPl: D:\\CMWProjects\\MO\\LFA1\\LFA1SPS1.IDPRO" },
            { id: "1.6.10", t: "Szem√©t t√∂r√∂lve?", g: "T√∂r√∂ltek minden r√©gi f√°jlt a projekt mapp√°b√≥l?\n(Csak <Berendez√©s>.S7TIA f√°jl lehet SPS-enk√©nt)" },
            { id: "1.6.11", t: "V√≠rusirt√≥ friss√ºl?", g: "Automatikusan friss√ºl a v√≠rusirt√≥ program?" }
        ]},
        { cat: "2.1.0 PLC (SPS)", items: [
            { id: "2.1.1", t: "Minden PLC ter√ºlet l√°tszik?", g: "Minden SPS ter√ºlet projekt√°lva van a berendez√©s-kiv√°laszt√°sban?" },
            { id: "2.1.2", t: "Minden ter√ºletnek van vizuja?", g: "L√©teznek projekt√°lt vizualiz√°ci√≥s k√©pek minden SPS ter√ºlethez?" },
            { id: "2.1.3", t: "Full HD felbont√°s?", g: "Az Integra Projekt Var√°zsl√≥ban (Wizard) a Full HD felbont√°st v√°lasztott√°k ki?" },
            { id: "2.1.4", t: "Calibri 10 Bold?", g: "Minden elemn√©l a szabv√°nyos bet≈±t√≠pust (Calibri, F√©lk√∂v√©r, 10-es m√©ret, ‚ÄûAlignment taLeftJustify‚Äù) haszn√°lt√°k?" },
            { id: "2.1.5", t: "Pult 99 (Nyers) ablak?", g: "A f√∂l√©rendelt Pult 99 (Karossz√©ria/Rohbau) eset√©ben az √°ttekint≈ë k√©pet a helyettes√≠t≈ë ablak funkci√≥val jelen√≠tett√©k meg?" },
            { id: "2.1.6", t: "PNG √°tl√°tsz√≥ k√©pek?", g: "A k√©pek megjelen√≠t√©se PNG form√°tumban, √°tl√°tsz√≥ h√°tt√©rrel, max. kb. 100KB f√°jlm√©rettel t√∂rt√©nt?\n\nEl≈ënyben kell r√©szes√≠teni a CAD rajzokat, pl.: funkcion√°lis elrendez√©si tervekb≈ël, szersz√°m √°ttekint√©sekb≈ël stb." }
        ]},
        { cat: "2.2.0 K√âPERNY≈êK", items: [
            { id: "2.2.1", t: "√Åttekint≈ë k√©pek OK?", g: "Az √°ttekint≈ë k√©pek (√úbersichtbilder) az Ir√°nyelv (Guideline) szerint lettek projekt√°lva?\n\n(L√°sd: RB p√©lda / FT p√©lda a dokument√°ci√≥ban)" },
            { id: "2.3.1", t: "Pult k√©pek OK?", g: "A pultter√ºlet k√©pei (Pultbereichsbilder) az Ir√°nyelv (Guideline) szerint lettek projekt√°lva?" },
            { id: "2.4.1", t: "√Ållom√°s k√©pek OK?", g: "Az √°llom√°s √°ttekint≈ë k√©pei az Ir√°nyelv (Guideline) szerint lettek projekt√°lva?" },
            { id: "2.5.1", t: "Speci√°lis funkci√≥k OK?", g: "A speci√°lis funkci√≥k (Sonderfunktionen) az Ir√°nyelv (Guideline) szerint lettek projekt√°lva?" },
            { id: "2.5.2", t: "Zusatzfenster OK?", g: "A kieg√©sz√≠t≈ë ablakok (Zusatzfenster) az Ir√°nyelv (Guideline) szerint lettek projekt√°lva?\n(P√©lda: Ragaszt√°s kieg√©sz√≠t≈ë ablak)" },
            { id: "2.5.3", t: "Betriebsfunktionen OK?", g: "Az √ºzemi funkci√≥k (Betriebsfunktionen) az Ir√°nyelv (Guideline) szerint lettek projekt√°lva?" },
            { id: "2.5.4", t: "Robot √°ttekint≈ëk OK?", g: "A robot √°ttekint≈ë k√©pek az Ir√°nyelv (Guideline) szerint lettek projekt√°lva?" },
            { id: "2.6.0", t: "R√©szletk√©pek (Zusatz)", g: "√Ållom√°sok r√©szletk√©pei (tov√°bbi k√©pek)" },
            { id: "2.6.1", t: "Nincs Station/Pult elem?", g: "Nem haszn√°ltak f√∂l√©rendelt elemeket, mint p√©ld√°ul √Ållom√°s, Pult stb. (a t√∂bbsz√∂r√∂s hiba√ºzenetek elker√ºl√©se √©rdek√©ben)?" },
            { id: "2.6.2", t: "V√©szle√°ll√≠t√≥ (SonderBit)?", g: "Nem haszn√°ltak V√©szle√°ll√≠t√≥ elemet a kiv√°laszt√°si list√°b√≥l?\n\nEhhez a funkci√≥hoz a r√©szletk√©pen a ‚ÄûDYN_GEN_SonderBit_Endlage_Absolut‚Äù vagy ‚ÄûDYN_GEN_SonderBit_LED_Absolut‚Äù sablont kell haszn√°lni." },
            { id: "2.6.3", t: "R√©szletk√©pek OK?", g: "A r√©szletk√©pek az Ir√°nyelv (Guideline) szerint lettek projekt√°lva? (P√©lda: Geostation)" }
        ]}
    ];

    // --- RENDEREL√âS ---
    const root = document.getElementById('root');

    function render() {
        data.forEach((sect, idx) => {
            const h = document.createElement('div');
            h.className = 'section-header';
            h.innerHTML = `<span>${sect.cat}</span> <span>‚ñº</span>`;
            h.onclick = () => document.getElementById(`sec-${idx}`).classList.toggle('active');
            
            const c = document.createElement('div');
            c.className = 'section-content';
            c.id = `sec-${idx}`;
            if(idx === 0) c.classList.add('active'); 

            sect.items.forEach(item => {
                const uid = item.id.replace(/\./g, '_');
                c.innerHTML += `
                    <div class="item-box" id="box-${uid}" data-id="${item.id}">
                        <span class="id-tag">${item.id}</span>
                        <div class="q-text">${item.t}</div>
                        <div class="btn-row">
                            <button class="btn-guide" onclick="toggleDetails('${uid}')">?</button>
                            <button class="btn-photo" id="btn-p-${uid}" onclick="togglePhoto('${uid}')">üì∑</button>
                            <button class="btn-ok" onclick="setStatus('${uid}', 'OK')">OK</button>
                            <button class="btn-nok" onclick="setStatus('${uid}', 'NOK')">NOK</button>
                        </div>
                        
                        <div class="details" id="det-${uid}">
                            <div class="guide-box">${item.g}</div>
                            <textarea placeholder="Excel Megjegyz√©s (Magyar)..." id="com-${uid}"></textarea>
                        </div>

                        <div class="photo-section" id="pho-${uid}">
                            <img id="img-prev-${uid}" class="photo-preview" />
                            <input type="file" accept="image/*" class="photo-input" id="inp-file-${uid}" onchange="savePhoto(event, '${uid}')">
                            <button class="btn-action" style="background:#333; color:var(--primary); margin-bottom:5px;" onclick="document.getElementById('inp-file-${uid}').click()">
                                üì§ FOT√ì FELT√ñLT√âSE
                            </button>
                            <textarea id="p-desc-${uid}" placeholder="Fot√≥ le√≠r√°sa (ez ker√ºl a PDF-be)..." oninput="savePhotoDesc('${uid}')"></textarea>
                        </div>
                    </div>
                `;
            });
            root.appendChild(h);
            root.appendChild(c);
        });
    }

    // --- FELHASZN√ÅL√ìI INTERAKCI√ìK ---
    function toggleDetails(uid) {
        const el = document.getElementById(`det-${uid}`);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function togglePhoto(uid) {
        const el = document.getElementById(`pho-${uid}`);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    // --- √öJ: K√âP T√ñM√ñR√çT√âS FUNKCI√ì ---
    // Ez a f√ºggv√©ny felel a k√©p √°tm√©retez√©s√©√©rt √©s t√∂m√∂r√≠t√©s√©√©rt
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // √Åtm√©retez√©s (ar√°nytart√≥an)
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // T√∂m√∂r√≠t√©s JPEG form√°tumba (pl. 0.7 = 70% min≈ës√©g)
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = error => reject(error);
            };
            reader.onerror = error => reject(error);
        });
    }

    // --- M√ìDOS√çTOTT FOT√ì MENT√âS ---
    async function savePhoto(event, uid) {
        const file = event.target.files[0];
        if (file) {
            // Gomb √°tv√°lt√°sa "T√∂lt√©s..." √°llapotra (opcion√°lis, de j√≥ visszajelz√©s)
            const btn = document.querySelector(`#pho-${uid} .btn-action`);
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ T√∂m√∂r√≠t√©s...";

            try {
                // T√ñM√ñR√çT√âS H√çV√ÅSA: Max 1200px sz√©less√©g, 70%-os min≈ës√©g
                const compressedBase64 = await compressImage(file, 1200, 0.7);
                
                // Megjelen√≠t√©s
                const img = document.getElementById(`img-prev-${uid}`);
                img.src = compressedBase64;
                img.style.display = 'block';
                
                // Gomb sz√≠nez√©se
                document.getElementById(`btn-p-${uid}`).classList.add('btn-has-photo');
                
                // Adatt√°rol√°s
                if(!photoStore[uid]) photoStore[uid] = {};
                photoStore[uid].img = compressedBase64;

            } catch (err) {
                console.error("Hiba a t√∂m√∂r√≠t√©sn√©l:", err);
                alert("Hiba a k√©p feldolgoz√°sakor!");
            } finally {
                btn.innerText = originalText;
            }
        }
    }

    function savePhotoDesc(uid) {
        const text = document.getElementById(`p-desc-${uid}`).value;
        if(!photoStore[uid]) photoStore[uid] = {};
        photoStore[uid].desc = text;
    }

    function setStatus(uid, s) {
        const box = document.getElementById(`box-${uid}`);
        const btns = box.querySelectorAll('.btn-row button');
        btns[2].classList.remove('active');
        btns[3].classList.remove('active');
        
        box.setAttribute('data-status', s);

        if(s === 'OK') { btns[2].classList.add('active'); } 
        else { btns[3].classList.add('active'); document.getElementById(`det-${uid}`).style.display = 'block'; }
        calc();
    }

    function calc() {
        const all = document.querySelectorAll('.item-box').length;
        const ok = document.querySelectorAll('.item-box[data-status="OK"]').length;
        const pct = all > 0 ? Math.round((ok/all)*100) : 0;
        document.getElementById('scoreDisplay').innerText = pct + "%";
    }

    function syncData() {
        // Placeholder
    }

    // --- MODERN PDF GENER√ÅL√ÅS ---
    function generateModernPDF() {
        const dev = document.getElementById('devName').value || "Nincs megadva";
        const plc = document.getElementById('plcNum').value || "-";
        const op = document.getElementById('opName').value || "-";
        const score = document.getElementById('scoreDisplay').innerText;
        const date = new Date().toLocaleDateString('hu-HU');

        let contentHtml = "";
        const allItems = document.querySelectorAll('.item-box');

        allItems.forEach(box => {
            const uid = box.id.replace('box-', '');
            const idTag = box.querySelector('.id-tag').innerText;
            const text = box.querySelector('.q-text').innerText;
            const status = box.getAttribute('data-status');
            const comment = document.getElementById(`com-${uid}`).value;
            
            if (!status) return; 

            const photoData = photoStore[uid];
            let photoHtml = "";
            if (photoData && photoData.img) {
                photoHtml = `
                    <div class="rb-photo-row">
                        <img src="${photoData.img}" class="rb-img">
                        <div class="rb-desc">
                            <span class="rb-desc-label">FOT√ì LE√çR√ÅS:</span>
                            ${photoData.desc || "Nincs le√≠r√°s megadva."}
                        </div>
                    </div>
                `;
            }

            contentHtml += `
                <div class="report-block">
                    <div class="rb-header">
                        <span class="rb-id">${idTag}</span>
                        <span class="rb-status ${status}">${status}</span>
                    </div>
                    <div class="rb-text">${text}</div>
                    ${comment ? `<div class="rb-comment">Megjegyz√©s: ${comment}</div>` : ''}
                    ${photoHtml}
                </div>
            `;
        });

        if(contentHtml === "") contentHtml = "<p style='text-align:center; padding:20px;'>Nincs ki√©rt√©kelt adat.</p>";

        const container = document.getElementById('print-container');
        container.innerHTML = `
            <div class="report-header">
                <h1 class="report-title">INTEGRA JEGYZ≈êK√ñNYV</h1>
                <div class="report-meta">
                    D√°tum: ${date}<br>
                    Gener√°lva: Integra Check v18
                </div>
            </div>

            <div class="report-summary">
                <div class="sum-item">
                    <div class="sum-val">${dev}</div>
                    <div class="sum-lbl">Berendez√©s</div>
                </div>
                <div class="sum-item">
                    <div class="sum-val">SPS ${plc}</div>
                    <div class="sum-lbl">PLC</div>
                </div>
                <div class="sum-item">
                    <div class="sum-val">${op}</div>
                    <div class="sum-lbl">Ellen≈ër</div>
                </div>
                <div class="sum-item">
                    <div class="sum-val" style="color:${parseInt(score) === 100 ? 'green' : 'red'}">${score}</div>
                    <div class="sum-lbl">Eredm√©ny</div>
                </div>
            </div>

            <div class="report-body">
                ${contentHtml}
            </div>
        `;

        window.print();
    }

    // --- EXCEL EXPORT ---
    async function translateText(text) {
        if (!text || text.trim() === "") return "";
        try {
            const url = `${TRANSLATE_API}?q=${encodeURIComponent(text)}&langpair=hu|de&mt=1`;
            const res = await fetch(url);
            const json = await res.json();
            if (json.responseData && json.responseData.translatedText) {
                return json.responseData.translatedText;
            }
            return text;
        } catch (e) {
            console.error("Ford√≠t√°si hiba:", e);
            return text;
        }
    }

    async function startAutoExport() {
        const devName = document.getElementById('devName').value;
        const plcNum = document.getElementById('plcNum').value;
        
        if(!devName || !plcNum) { 
            alert("K√©rlek t√∂ltsd ki a Berendez√©s nev√©t (XXXX) √©s a PLC sz√°m√°t!"); 
            return; 
        }

        const btn = document.getElementById('btnExport');
        const status = document.getElementById('statusText');

        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> LET√ñLT√âS...';
        status.innerText = "Sablon let√∂lt√©se...";

        try {
            const response = await fetch(GITHUB_TEMPLATE_URL);
            if(!response.ok) throw new Error("Hiba a sablon let√∂lt√©sekor. Ellen≈ërizd az internetet!");
            const buffer = await response.arrayBuffer();

            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(buffer);
            workbook.calcProperties.fullCalcOnLoad = true;

            const allItems = document.querySelectorAll('.item-box');
            
            status.innerText = "Adatok √≠r√°sa & Ford√≠t√°s...";
            btn.innerHTML = '<div class="spinner"></div> FORD√çT√ÅS...';

            for (const item of allItems) {
                const id = item.getAttribute('data-id');
                const stat = item.getAttribute('data-status');
                const uid = id.replace(/\./g, '_');
                const hungarianComment = document.getElementById(`com-${uid}`).value;
                
                let germanComment = "";
                if(hungarianComment.length > 0) {
                    germanComment = await translateText(hungarianComment);
                }

                let keywords = [];
                if (id.startsWith("1.")) keywords = ["Check", "punkte", "1"];
                else if (id.startsWith("2.")) keywords = ["Visu", "Detail", "2"];

                const worksheet = workbook.worksheets.find(ws => {
                    const name = ws.name.toLowerCase();
                    return keywords.some(k => name.includes(k.toLowerCase()));
                });

                if (worksheet) {
                    let targetRow = null;
                    worksheet.eachRow((row) => {
                        const cellA = row.getCell(1).value; 
                        if (cellA && cellA.toString().trim() == id) targetRow = row;
                    });

                    if (targetRow) {
                        const cellC = targetRow.getCell(3); 
                        const cellD = targetRow.getCell(4); 
                        const cellF = targetRow.getCell(6); 
                        
                        cellC.value = null; cellD.value = null; cellF.value = null;

                        if (stat === "OK") {
                            cellC.value = "x";
                            cellC.type = ExcelJS.ValueType.String; 
                            cellC.alignment = { horizontal: 'center' };
                        } else if (stat === "NOK") {
                            cellD.value = "x";
                            cellD.type = ExcelJS.ValueType.String;
                            cellD.alignment = { horizontal: 'center' };
                        }

                        if (germanComment) {
                            cellF.value = germanComment;
                        }
                    }
                }
            }

            let finalFileName = "DE_PCS_031_02_XXXX_SPSX_Visu Checkliste.xlsx";
            finalFileName = finalFileName.replace("XXXX", devName);
            finalFileName = finalFileName.replace("SPSX", "SPS" + plcNum);

            btn.innerHTML = '<div class="spinner"></div> MENT√âS...';
            
            const outBuffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([outBuffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            
            const url = window.URL.createObjectURL(blob);
            const anchor = document.createElement("a");
            anchor.href = url;
            anchor.download = finalFileName; 
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
            
            status.innerText = "K√©sz!";
            alert(`Sikeres ment√©s!\n\nFONTOS: A sz√°mok friss√≠t√©s√©hez az Excelben kattints a 'Szerkeszt√©s enged√©lyez√©se' gombra (s√°rga s√°v)!`);

        } catch (err) {
            console.error(err);
            alert("Hiba: " + err.message);
            status.innerText = "Hiba";
        } finally {
            btn.disabled = false;
            btn.innerHTML = '‚òÅÔ∏è EXCEL MENT√âS';
        }
    }

    render();
</script>

</body>
</html>

